---
title: "AppendixMatching"
author: "Ľuboš Perniš"
date: "08/04/2019"
output:
  pdf_document:
    keep_tex: TRUE
    template: default.latex
    number_sections: TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# <- '../../TreatmentHet/'
source('functions/causalMatchFNN_ties.R')
source('functions/standardMatch.R')
d1 <- readRDS(paste0('data/d1.Rds'))
d0 <- readRDS('data/d0_unlucky.Rds')
true_ate <- mean(d1$y1) - mean(d1$y0)
library(ggplot2)
getwd()
```

# Standard vs. Causal Matching

Conventional matching for ATE prediction performs relatively well when the distribution of potential outcomes is close to equal between the treatment and the control group in the initial location. Later, I show that under the assumptions used throughout this dissertation (randomisation,unconfoundedness of location and overlap), matching is an unbiased estimator of ATE in the target location. However, no single randomisation is achieves perfect balance. As explained in the dissertation, in these situations, matching leads to underestimation or overestimation of the predicted ATE.

In this appendix, I show by simulation that the causalMatch algorithm predicts the ATE for the target location with lower variance than the standard matching knn matching algorithm. 

## The treatment effect
For each observation $i$, we define the treatment effect as

$$
\tau_i = 2 + 10 \times x^1_i
$$

## Target location
The target location consists of 499 individuals with the true treatment effect of `r round(true_ate, 2)` and with the following distribution of covariate $x^1$

```{r echo=FALSE}
d0_dis <- d0[, 1:3]
d1_dis <- d1[, 1:3]

d0_dis$d <- 0 
d1_dis$d <- 1

locCombined <- rbind(d0_dis, d1_dis)

ggplot(locCombined, aes(x1, fill = factor(d))) + geom_density(alpha = 0.2)  + scale_fill_discrete(name = 'Location') + ggsave('images/app_matching_comp.png')
```

## Initial location

```{r echo=FALSE}
ggplot(d1, aes(x1, fill = 'blue')) + geom_density(alpha = 0.2) + 
  scale_fill_discrete(guide = FALSE)
```


## "Lucky randomisation"

First, consider a situation of a lucky randomisation where the distribution of covariate $x^1$ is similar for both the individuals under treatment and under control in the initial location. 

```{r echo=FALSE}
d0_lucky <- readRDS(paste0('data/d0_lucky.Rds'))
ggplot(d0_lucky, aes(x1, fill = factor(t))) + geom_density(alpha = 0.2) + scale_fill_discrete(name = 'Treatment')
```

Then, when we use the standard matching procedure to obtain an ATE prediction for the target location. We compute the error of the prediction as

$$
MSE = (Y - \hat{Y}) ^ 2
$$
where ${Y}$ is the predicted ATE for the target location and $\hat{Y}$ the true ATE for the location defined as

$$
\hat{Y} = E[Y_i (1) - Y_i(0)]
$$

```{r include=FALSE}
error_lucky <- (Match(d1, d0_lucky, 'x1') - true_ate) ^2 
error_lucky_causalMatch <- (causalMatchFNN(d1, d0_lucky, 'x1') - true_ate) ^ 2
```

The error equals `r round(error_lucky, 2)` and `r round(error_lucky_causalMatch, 2)` for the causalMatch procedure. We already see that even for small imbalances, causalMatch performs better than the standard matching.  

## Unlucky randomisation
Now we simulate a case where half of the individuals with lowest potential outcomes were assigned to treatment condition. In reality this means that there is large imbalance in potential outcomes between individuals assigned to treatment and control conditions.

```{r include=FALSE}
d0_unlucky <- readRDS(paste0('data/d0_unlucky.Rds'))
```

```{r echo=FALSE}
ggplot(d0_unlucky, aes(x1, fill = factor(t))) + geom_density(alpha = 0.2) + scale_fill_discrete(name = 'Treatment')
```


```{r include=FALSE}
error_unlucky_standardMatch <- (Match(d1, d0_unlucky, 'x1') - true_ate) ^2 
error_unlucky_causalMatch <- (causalMatchFNN(d1, d0_unlucky, 'x1') - true_ate) ^ 2
```

We again perform both types of matching. The prediction error is `r round(error_unlucky_standardMatch, 2)` with standard matching and `r round(error_unlucky_causalMatch, 2)` with the causalMatch procedure. We see that even though both 

## Simulation case
Finally, I show that over repeated randomisation of treatment assignment for the initial location, the average difference between the true ATE and the predicted ATE is close to zero. 

To do this, we calculate the predicted ATE from both methods for 100 random allocations of treatment. 

```{r include=FALSE}
# Create a helper function for re-assigning treatment
reassign_treatment <- function(dataset) {
  random <- sample(1:nrow(d0))
  treat_rows <- random[1:floor(0.5*length(random))]
  dataset$t <- NA
  dataset$t[treat_rows] <- 1
  dataset$t[-treat_rows] <- 0
  dataset$y <- ifelse(dataset$t == 1, dataset$y1, dataset$y0)
  return(dataset)
}
```

```{r include=FALSE}
d0 <- d0_lucky
### Perform both Matchings
diff_causal <- numeric()
diff_standard <- numeric()
for(i in 1:100){
  # For each re-assign treatment
  d0 <- reassign_treatment(d0)
  # Define baseline cases
  true_ate <- mean(d1$y1)-mean(d1$y0)
  initial_ate <- mean(d0$y[d0$t == 1]) - mean(d0$y[d0$t == 0])
  # Compute the mean squared error of the predictions for Standard Match with reassignment
  ms<- Match(d1, d0, 'x1')
  diff_standard[i] <- (ms - true_ate)
  
  # Causal Match
  mc <- causalMatchFNN(d1, d0, 'x1')
  diff_causal[i] <- (mc - true_ate)

  #
  print(paste0('Iteration: ', i))
  
}
```

```{r echo=FALSE}
hist(diff_standard, breaks = 20, main = 'standard Matching', xlab = 'Difference')
abline(v = mean(diff_standard), col = 'red')
```

```{r echo=FALSE}
hist(diff_causal, breaks = 20, main = 'causalMatch', xlab = 'Difference')
abline(v = mean(diff_causal), col = 'red')
```

